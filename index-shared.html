<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­è¡¨ç™½å¢™ (å…±äº«ç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .header button {
            color: white;
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .header button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* è¡¨å•æ ·å¼ */
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff9a9e;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .submit-btn {
            background: linear-gradient(to right, #ff9a9e, #fad0c4);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s;
            display: block;
            margin: 0 auto;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #ff9a9e;
            background-color: rgba(255, 154, 158, 0.1);
        }

        .upload-area.dragover {
            border-color: #ff9a9e;
            background-color: rgba(255, 154, 158, 0.2);
        }

        .preview-container {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .preview-item:hover {
            transform: translateY(-2px);
        }

        .preview-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .preview-video {
            width: 120px;
            height: 120px;
            background: #000;
            display: block;
            object-fit: cover;
        }

        .video-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            overflow: hidden;
            border-radius: 8px;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 14px;
            pointer-events: none;
        }

        .video-loading {
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .file-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 8px;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .file-info span:first-child {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-info span:last-child {
            opacity: 0.8;
            font-size: 10px;
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background: #e74c3c;
            color: white;
        }

        /* è¡¨ç™½å¢™æ ·å¼ */
        .wall-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .wall-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff9a9e;
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #f1f1f1;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #ff9a9e;
            color: white;
        }

        .wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .empty-wall {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 18px;
        }

        /* è¡¨ç™½å¡ç‰‡æ ·å¼ */
        .confession-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .confession-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .card-to {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .card-type {
            font-size: 24px;
        }

        .card-content {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .card-from {
            text-align: right;
            font-weight: bold;
            color: #666;
        }

        .card-time {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* è¡¨ç™½å¡ç‰‡ä¸­çš„åª’ä½“å†…å®¹ */
        .card-media {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .card-media img,
        .card-media video {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            display: block;
        }

        /* åª’ä½“å¯ç‚¹å‡»æ•ˆæœ */
        .media-clickable {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .media-clickable:hover {
            transform: scale(1.02);
        }

        /* ç›¸å†Œå¼¹çª—æ ·å¼ */
        .media-gallery {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .gallery-content {
            width: 80%;
            max-width: 900px;
            height: 80%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            color: white;
            cursor: pointer;
            background: none;
            border: none;
        }

        .gallery-media {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }

        .gallery-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            color: white;
            margin-top: 20px;
        }

        .gallery-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 90%;
        }

        .gallery-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }

        .sync-status.online {
            background: rgba(40, 167, 69, 0.7);
        }

        .sync-status.offline {
            background: rgba(220, 53, 69, 0.7);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-container,
            .wall-container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .wall {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ’• æ ¡å›­è¡¨ç™½å¢™</h1>
            <p>å‹‡æ•¢è¡¨è¾¾ä½ çš„å¿ƒæ„ï¼Œè®©çˆ±ä¼ é€’æ•´ä¸ªæ ¡å›­ (å…±äº«ç‰ˆ)</p>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="refreshBtn" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer;">
                    ğŸ”„ åˆ·æ–°è¡¨ç™½
                </button>
                <button id="syncBtn" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer;">
                    ğŸ”„ åŒæ­¥æ•°æ®
                </button>
                <button id="exportBtn" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer;">
                    ğŸ“¥ å¯¼å‡ºæ•°æ®
                </button>
                <button id="importBtn" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; border: none; cursor: pointer;">
                    ğŸ“¤ å¯¼å…¥æ•°æ®
                </button>
                <a href="index.html" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px;">
                    ğŸ”’ è¿”å›å•æœºç‰ˆ
                </a>
            </div>
        </header>

        <div class="form-container">
            <form id="confessionForm">
                <div class="form-group">
                    <label for="to">è‡´ï¼š</label>
                    <input type="text" id="to" placeholder="è¯·è¾“å…¥æ¥æ”¶äººå§“å" required>
                </div>
                
                <div class="form-group">
                    <label for="from">å‘é€äººï¼š</label>
                    <input type="text" id="from" placeholder="ä½ çš„å§“åï¼ˆå¯ç•™ç©ºï¼‰">
                </div>
                
                <div class="form-group">
                    <label for="content">è¡¨ç™½å†…å®¹ï¼š</label>
                    <textarea id="content" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡/è§†é¢‘ï¼š</label>
                    <div id="uploadArea" class="upload-area">
                        <div class="upload-text">
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                            <small>æ”¯æŒå›¾ç‰‡(JPG, PNG, GIF)å’Œè§†é¢‘(MP4, WebM, AVI, MOVç­‰)ï¼Œæœ€å¤§50MB</small>
                        </div>
                        <input type="file" id="mediaInput" accept="image/*,video/*" multiple style="display: none;">
                    </div>
                    <div id="previewContainer" class="preview-container">
                        <!-- é¢„è§ˆæ–‡ä»¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="type">è¡¨ç™½ç±»å‹ï¼š</label>
                    <select id="type">
                        <option value="love">ğŸ’˜ çˆ±æƒ…è¡¨ç™½</option>
                        <option value="friendship">ğŸ¤ å‹æƒ…è¡¨ç™½</option>
                        <option value="admiration">ğŸŒŸ æ¬£èµè¡¨ç™½</option>
                        <option value="thanks">ğŸ™ æ„Ÿè°¢è¡¨ç™½</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-btn">å‘å¸ƒè¡¨ç™½</button>
            </form>
        </div>

        <div class="wall-container">
            <h2>è¡¨ç™½å¢™</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="love">ğŸ’˜ çˆ±æƒ…</button>
                <button class="filter-btn" data-filter="friendship">ğŸ¤ å‹æƒ…</button>
                <button class="filter-btn" data-filter="admiration">ğŸŒŸ æ¬£èµ</button>
                <button class="filter-btn" data-filter="thanks">ğŸ™ æ„Ÿè°¢</button>
            </div>
            <div id="wall" class="wall">
                <div class="empty-wall">æ­£åœ¨åŠ è½½è¡¨ç™½å¢™...</div>
            </div>
        </div>
    </div>

    <!-- åª’ä½“ç›¸å†Œå¼¹çª— -->
    <div id="media-gallery" class="media-gallery">
        <button class="gallery-close">&times;</button>
        <div class="gallery-content">
            <img id="gallery-image" class="gallery-media" style="display: none;">
            <video id="gallery-video" class="gallery-media" controls style="display: none;"></video>
            <div class="gallery-info">
                <span id="gallery-title">æ–‡ä»¶åç§°</span>
                <span id="gallery-index">1 / 1</span>
            </div>
        </div>
    </div>

    <!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="syncStatus" class="sync-status">
        è¿æ¥ä¸­...
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <script>
        class SharedConfessionWall {
            constructor() {
                this.confessions = [];
                this.currentFilter = 'all';
                this.selectedFiles = [];
                this.gallery = {
                    mediaList: [],
                    currentIndex: 0
                };
                this.syncServerUrl = window.location.protocol + '//' + window.location.hostname + ':8002';
                this.init();
            }

            // åˆå§‹åŒ–åº”ç”¨
            init() {
                this.bindEvents();
                this.loadConfessions();
                this.renderWall();
                
                // è®¾ç½®å®šæœŸåŒæ­¥
                this.setupPeriodicSync();
            }

            // è®¾ç½®å®šæœŸåŒæ­¥
            setupPeriodicSync() {
                // æ¯30ç§’åŒæ­¥ä¸€æ¬¡æ•°æ®
                setInterval(() => {
                    this.loadConfessions();
                }, 30000);
                
                // æ¯5ç§’æ£€æŸ¥è¿æ¥çŠ¶æ€
                setInterval(() => {
                    this.checkConnectionStatus();
                }, 5000);
            }

            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            checkConnectionStatus() {
                const statusEl = document.getElementById('syncStatus');
                
                fetch(this.syncServerUrl + '/api/confessions')
                    .then(response => {
                        if (response.ok) {
                            statusEl.textContent = 'åœ¨çº¿';
                            statusEl.className = 'sync-status online';
                        } else {
                            statusEl.textContent = 'ç¦»çº¿';
                            statusEl.className = 'sync-status offline';
                        }
                    })
                    .catch(error => {
                        statusEl.textContent = 'ç¦»çº¿';
                        statusEl.className = 'sync-status offline';
                    });
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                // è¡¨å•æäº¤äº‹ä»¶
                document.getElementById('confessionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitConfession();
                });

                // è¿‡æ»¤å™¨æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setFilter(e.target.dataset.filter);
                    });
                });
                
                // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
                this.setupFileUpload();
                
                // åª’ä½“ç›¸å†Œäº‹ä»¶
                this.setupMediaGallery();
                
                // åˆ·æ–°æŒ‰é’®äº‹ä»¶
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadConfessions();
                    this.renderWall();
                });
                
                // åŒæ­¥æŒ‰é’®äº‹ä»¶
                document.getElementById('syncBtn').addEventListener('click', () => {
                    this.loadConfessions();
                    this.renderWall();
                    alert('æ•°æ®åŒæ­¥å®Œæˆï¼');
                });
                
                // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });
                
                // å¯¼å…¥æŒ‰é’®äº‹ä»¶
                document.getElementById('importBtn').addEventListener('click', () => {
                    document.getElementById('importFileInput').click();
                });
                
                // å¯¼å…¥æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                document.getElementById('importFileInput').addEventListener('change', (e) => {
                    this.importData(e.target.files[0]);
                });
            }

            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
            setupFileUpload() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('mediaInput');
                const previewContainer = document.getElementById('previewContainer');

                // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                    fileInput.value = '';
                });

                // æ‹–æ‹½äº‹ä»¶
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });

                // ç§»é™¤é¢„è§ˆé¡¹äº‹ä»¶å§”æ‰˜
                previewContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-btn')) {
                        const fileName = e.target.dataset.file;
                        this.removeFile(fileName);
                    }
                });
            }

            // è®¾ç½®åª’ä½“ç›¸å†ŒåŠŸèƒ½
            setupMediaGallery() {
                const gallery = document.getElementById('media-gallery');
                const closeBtn = gallery.querySelector('.gallery-close');

                // å…³é—­ç›¸å†Œ
                closeBtn.addEventListener('click', () => {
                    this.closeMediaGallery();
                });

                // ç‚¹å‡»èƒŒæ™¯å…³é—­ç›¸å†Œ
                gallery.addEventListener('click', (e) => {
                    if (e.target === gallery) {
                        this.closeMediaGallery();
                    }
                });

                // ESCé”®å…³é—­ç›¸å†Œ
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && gallery.style.display === 'flex') {
                        this.closeMediaGallery();
                    }
                });
            }

            // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
            handleFiles(files) {
                const MAX_SIZE = 50 * 1024 * 1024; // 50MB

                for (let file of files) {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°
                    if (file.size > MAX_SIZE) {
                        this.showErrorMessage(`æ–‡ä»¶"${file.name}"å¤§å°è¶…è¿‡50MBé™åˆ¶`);
                        continue;
                    }

                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                        // æ–‡ä»¶æœ‰æ•ˆï¼Œæ·»åŠ åˆ°åˆ—è¡¨
                        if (!this.selectedFiles.find(f => f.name === file.name)) {
                            this.selectedFiles.push(file);
                            this.addFilePreview(file);
                        }
                    } else {
                        this.showErrorMessage(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.type}`);
                        continue;
                    }
                }
            }

            // æ·»åŠ æ–‡ä»¶é¢„è§ˆ
            addFilePreview(file) {
                const previewContainer = document.getElementById('previewContainer');
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.dataset.file = file.name;

                const fileURL = URL.createObjectURL(file);
                
                if (file.type.startsWith('image/')) {
                    previewItem.innerHTML = `
                        <img src="${fileURL}" alt="${file.name}" class="preview-image">
                        <div class="file-info">
                            <span>${file.name}</span>
                            <span>${this.formatFileSize(file.size)}</span>
                        </div>
                        <button class="remove-btn" data-file="${file.name}">Ã—</button>
                    `;
                } else if (file.type.startsWith('video/')) {
                    previewItem.innerHTML = `
                        <div class="video-wrapper">
                            <video class="preview-video" preload="metadata" muted>
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                            </video>
                            <div class="video-overlay">
                                <div class="video-loading">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                        <div class="file-info">
                            <span>${file.name}</span>
                            <span>${this.formatFileSize(file.size)}</span>
                        </div>
                        <button class="remove-btn" data-file="${file.name}">Ã—</button>
                    `;
                    
                    const videoElement = previewItem.querySelector('video');
                    const loadingOverlay = previewItem.querySelector('.video-loading');
                    
                    videoElement.src = fileURL;
                    
                    videoElement.addEventListener('loadeddata', () => {
                        if (loadingOverlay) {
                            loadingOverlay.textContent = 'âœ…';
                            setTimeout(() => {
                                const overlay = previewItem.querySelector('.video-overlay');
                                if (overlay) overlay.style.display = 'none';
                            }, 1000);
                        }
                    });
                }
                
                previewContainer.appendChild(previewItem);
            }

            // ç§»é™¤æ–‡ä»¶
            removeFile(fileName) {
                this.selectedFiles = this.selectedFiles.filter(file => file.name !== fileName);
                
                // ç§»é™¤å¯¹åº”çš„é¢„è§ˆé¡¹
                const previewItem = document.querySelector(`[data-file="${fileName}"]`);
                if (previewItem) {
                    previewItem.remove();
                }
            }

            // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showErrorMessage(message) {
                alert(message);
                console.error(message);
            }

            // åŠ è½½è¡¨ç™½æ•°æ®
            loadConfessions() {
                fetch(this.syncServerUrl + '/api/confessions')
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('åŠ è½½æ•°æ®å¤±è´¥');
                        }
                    })
                    .then(data => {
                        this.confessions = data;
                        this.renderWall();
                        console.log('æˆåŠŸåŠ è½½è¡¨ç™½æ•°æ®:', data.length, 'æ¡');
                    })
                    .catch(error => {
                        console.error('åŠ è½½è¡¨ç™½æ•°æ®å¤±è´¥:', error);
                        const wall = document.getElementById('wall');
                        wall.innerHTML = '<div class="empty-wall">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•</div>';
                    });
            }

            // æäº¤è¡¨ç™½
            async submitConfession() {
                const to = document.getElementById('to').value.trim();
                const from = document.getElementById('from').value.trim() || 'åŒ¿å';
                const content = document.getElementById('content').value.trim();
                const type = document.getElementById('type').value;

                if (!to || !content) {
                    alert('è¯·å¡«å†™æ¥æ”¶äººå’Œè¡¨ç™½å†…å®¹ï¼');
                    return;
                }

                // åˆ›å»ºè¡¨ç™½å¯¹è±¡
                const confession = {
                    id: Date.now() + Math.random(),
                    to,
                    from,
                    content,
                    type,
                    timestamp: new Date().toLocaleString('zh-CN'),
                    likes: 0,
                    media: []
                };

                // å¤„ç†æ–‡ä»¶
                if (this.selectedFiles.length > 0) {
                    for (const file of this.selectedFiles) {
                        const dataUrl = await this.fileToDataURL(file);
                        confession.media.push({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: dataUrl
                        });
                    }
                }

                // æäº¤åˆ°æœåŠ¡å™¨
                fetch(this.syncServerUrl + '/api/confessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(confession)
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('æäº¤å¤±è´¥');
                    }
                })
                .then(data => {
                    if (data.success) {
                        // æ¸…ç©ºè¡¨å•å’Œé¢„è§ˆ
                        document.getElementById('confessionForm').reset();
                        document.getElementById('previewContainer').innerHTML = '';
                        this.selectedFiles = [];

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.showSuccessMessage();
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        this.loadConfessions();
                    } else {
                        alert('å‘å¸ƒå¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æäº¤è¡¨ç™½å¤±è´¥:', error);
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }

            // å°†æ–‡ä»¶è½¬æ¢ä¸ºDataURL
            fileToDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage() {
                const successMsg = document.createElement('div');
                successMsg.textContent = 'è¡¨ç™½å‘å¸ƒæˆåŠŸï¼';
                successMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(40, 167, 69, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 18px;
                    z-index: 1000;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                `;
                
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.style.opacity = '0';
                    successMsg.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        document.body.removeChild(successMsg);
                    }, 500);
                }, 2000);
            }

            // è®¾ç½®è¿‡æ»¤å™¨
            setFilter(filter) {
                this.currentFilter = filter;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.dataset.filter === filter) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // é‡æ–°æ¸²æŸ“è¡¨ç™½å¢™
                this.renderWall();
            }

            // æ¸²æŸ“è¡¨ç™½å¢™
            renderWall() {
                const wall = document.getElementById('wall');
                
                // è¿‡æ»¤è¡¨ç™½
                const filteredConfessions = this.currentFilter === 'all' 
                    ? this.confessions 
                    : this.confessions.filter(confession => confession.type === this.currentFilter);
                
                if (filteredConfessions.length === 0) {
                    wall.innerHTML = '<div class="empty-wall">æš‚æ— è¡¨ç™½ï¼Œå¿«æ¥åšç¬¬ä¸€ä¸ªå‘å¸ƒè€…å§ï¼</div>';
                    return;
                }
                
                wall.innerHTML = '';
                
                filteredConfessions.forEach(confession => {
                    const card = this.createConfessionCard(confession);
                    wall.appendChild(card);
                });
            }

            // åˆ›å»ºè¡¨ç™½å¡ç‰‡
            createConfessionCard(confession) {
                const card = document.createElement('div');
                card.className = `confession-card ${confession.type}`;
                
                // è·å–ç±»å‹æ ‡ç­¾
                const typeLabels = {
                    love: 'ğŸ’˜ çˆ±æƒ…è¡¨ç™½',
                    friendship: 'ğŸ¤ å‹æƒ…è¡¨ç™½',
                    admiration: 'ğŸŒŸ æ¬£èµè¡¨ç™½',
                    thanks: 'ğŸ™ æ„Ÿè°¢è¡¨ç™½'
                };
                
                const typeIcons = {
                    love: 'ğŸ’˜',
                    friendship: 'ğŸ¤',
                    admiration: 'ğŸŒŸ',
                    thanks: 'ğŸ™'
                };
                
                // åˆ›å»ºåª’ä½“å†…å®¹
                let mediaHTML = '';
                if (confession.media && confession.media.length > 0) {
                    // åˆ›å»ºåª’ä½“é¢„è§ˆç½‘æ ¼
                    let mediaGridHTML = '<div class="card-media">';
                    
                    confession.media.forEach((file, index) => {
                        if (file.type.startsWith('image/')) {
                            mediaGridHTML += `<img src="${file.data}" alt="${file.name}" class="media-clickable" data-index="${index}">`;
                        } else if (file.type.startsWith('video/')) {
                            mediaGridHTML += `<video src="${file.data}" class="media-clickable" data-index="${index}" onclick="event.preventDefault();"></video>`;
                        }
                    });
                    
                    mediaGridHTML += '</div>';
                    mediaHTML = mediaGridHTML;
                }
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-to">è‡´ ${confession.to}</div>
                        <div class="card-type">${typeIcons[confession.type]}</div>
                    </div>
                    <div class="card-content">
                        <p>${confession.content}</p>
                    </div>
                    ${mediaHTML}
                    <div class="card-from">â€”â€” ${confession.from}</div>
                    <div class="card-time">${confession.timestamp}</div>
                `;
                
                // ä¸ºåª’ä½“å…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (confession.media && confession.media.length > 0) {
                    card.querySelectorAll('.media-clickable').forEach((element, index) => {
                        element.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.openMediaGallery(confession, index);
                        });
                    });
                }
                
                return card;
            }

            // æ‰“å¼€åª’ä½“ç›¸å†Œ
            openMediaGallery(confession, startIndex = 0) {
                const gallery = document.getElementById('media-gallery');
                const galleryImage = document.getElementById('gallery-image');
                const galleryVideo = document.getElementById('gallery-video');
                
                // æ”¶é›†æ‰€æœ‰åª’ä½“æ–‡ä»¶
                this.gallery.mediaList = [];
                
                if (confession.media && confession.media.length > 0) {
                    confession.media.forEach((file, index) => {
                        this.gallery.mediaList.push({
                            type: file.type,
                            url: file.data,
                            name: file.name,
                            confession: confession
                        });
                    });
                }
                
                if (this.gallery.mediaList.length === 0) {
                    return;
                }
                
                // è®¾ç½®å½“å‰ç´¢å¼•
                this.gallery.currentIndex = Math.min(startIndex, this.gallery.mediaList.length - 1);
                
                // æ˜¾ç¤ºç›¸å†Œ
                gallery.style.display = 'flex';
                
                // æ˜¾ç¤ºå½“å‰åª’ä½“
                this.showGalleryMedia();
            }

            // æ˜¾ç¤ºç›¸å†Œä¸­çš„åª’ä½“
            showGalleryMedia() {
                const galleryImage = document.getElementById('gallery-image');
                const galleryVideo = document.getElementById('gallery-video');
                const galleryTitle = document.getElementById('gallery-title');
                const galleryIndex = document.getElementById('gallery-index');
                
                if (this.gallery.currentIndex < 0 || this.gallery.currentIndex >= this.gallery.mediaList.length) {
                    return;
                }
                
                const currentMedia = this.gallery.mediaList[this.gallery.currentIndex];
                
                // æ›´æ–°ä¿¡æ¯
                galleryTitle.textContent = currentMedia.name;
                galleryIndex.textContent = `${this.gallery.currentIndex + 1} / ${this.gallery.mediaList.length}`;
                
                // æ˜¾ç¤ºå›¾ç‰‡æˆ–è§†é¢‘
                if (currentMedia.type.startsWith('image/')) {
                    galleryImage.src = currentMedia.url;
                    galleryImage.style.display = 'block';
                    galleryVideo.style.display = 'none';
                } else if (currentMedia.type.startsWith('video/')) {
                    galleryVideo.src = currentMedia.url;
                    galleryVideo.style.display = 'block';
                    galleryImage.style.display = 'none';
                }
            }

            // å…³é—­åª’ä½“ç›¸å†Œ
            closeMediaGallery() {
                const gallery = document.getElementById('media-gallery');
                const galleryVideo = document.getElementById('gallery-video');
                
                gallery.style.display = 'none';
                galleryVideo.pause(); // æš‚åœè§†é¢‘
            }

            // å¯¼å‡ºæ•°æ®
            exportData() {
                const dataStr = JSON.stringify(this.confessions, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `confessions_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.style.display = 'none';
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                
                alert(`å¯¼å‡ºæˆåŠŸï¼å…±å¯¼å‡º ${this.confessions.length} æ¡è¡¨ç™½`);
            }

            // å¯¼å…¥æ•°æ®
            importData(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            data.forEach(confession => {
                                // æäº¤æ¯æ¡è¡¨ç™½åˆ°æœåŠ¡å™¨
                                fetch(this.syncServerUrl + '/api/confessions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(confession)
                                })
                                .then(response => {
                                    if (response.ok) {
                                        return response.json();
                                    } else {
                                        throw new Error('æäº¤å¤±è´¥');
                                    }
                                })
                                .then(result => {
                                    if (!result.success) {
                                        console.error('å¯¼å…¥è¡¨ç™½å¤±è´¥:', result.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('å¯¼å…¥è¡¨ç™½å¤±è´¥:', error);
                                });
                            });
                            
                            // é‡æ–°åŠ è½½æ•°æ®
                            this.loadConfessions();
                            
                            alert(`å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${data.length} æ¡è¡¨ç™½`);
                        } else {
                            alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„è¡¨ç™½æ•°æ®æ–‡ä»¶');
                        }
                    } catch (error) {
                        alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                        console.error('è§£ææ–‡ä»¶å¤±è´¥:', error);
                    }
                };
                
                reader.readAsText(file);
            }
        }

        // åˆå§‹åŒ–è¡¨ç™½å¢™
        let confessionWall;
        
        document.addEventListener('DOMContentLoaded', () => {
            confessionWall = new SharedConfessionWall();
        });
    </script>
</body>
</html>